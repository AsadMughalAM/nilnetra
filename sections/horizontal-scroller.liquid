{{ 'horizontal-scroller.css' | asset_url | stylesheet_tag }}

{%- style -%}
  #horizontal-{{ section.id }} {
    background: {{ section.settings.background_color | default: '#0f0f0f' }};
  }

  #horizontal-{{ section.id }}.content:nth-child(3) {
    width: {{ section.settings.panel_3_width | default: 70 }}
    vw !important;
  }
{%- endstyle -%}

<section
  id="horizontal-{{ section.id }}"
  class="horizontal-scroller"
  data-section-id="{{ section.id }}"
  data-section-type="horizontal-scroller">
  <div class="scroller-wrapper">
    {%- comment -%} Panel 1: Single Image {%- endcomment -%}
    <div class="content">
      {%- if section.settings.panel_1_image != blank -%}
        <img
          src="{{ section.settings.panel_1_image | image_url: width: 1200 }}"
          srcset="
            {{ section.settings.panel_1_image | image_url: width: 400 }} 400w,
            {{ section.settings.panel_1_image | image_url: width: 800 }} 800w,
            {{ section.settings.panel_1_image | image_url: width: 1200 }} 1200w
          "
          sizes="(max-width: 768px) 80vw, 50vw"
          width="1200"
          height="800"
          alt="{{ section.settings.panel_1_image.alt | default: 'Panel 1' | escape }}"
          loading="lazy"
          class="panel-image">
      {%- else -%}
        <img
          src="{{ 'content1.jpg' | asset_url }}"
          width="1200"
          height="800"
          alt="Content 1"
          loading="lazy"
          class="panel-image">
      {%- endif -%}
    </div>

    {%- comment -%} Panel 2: Two Images Side by Side {%- endcomment -%}
    <div class="content content-split">
      <div class="split-left">
        {%- if section.settings.panel_2_image_left != blank -%}
          <img
            src="{{ section.settings.panel_2_image_left | image_url: width: 800 }}"
            srcset="
              {{ section.settings.panel_2_image_left | image_url: width: 400 }} 400w,
              {{ section.settings.panel_2_image_left | image_url: width: 600 }} 600w,
              {{ section.settings.panel_2_image_left | image_url: width: 800 }} 800w
            "
            sizes="(max-width: 768px) 80vw, 30vw"
            width="800"
            height="600"
            alt="{{ section.settings.panel_2_image_left.alt | default: 'Left Image' | escape }}"
            loading="lazy"
            class="split-image">
        {%- else -%}
          <img
            src="{{ 'content2.jpg' | asset_url }}"
            width="800"
            height="600"
            alt="Content 2"
            loading="lazy"
            class="split-image">
        {%- endif -%}
      </div>

      <div class="split-right">
        {%- if section.settings.panel_2_image_right != blank -%}
          <img
            src="{{ section.settings.panel_2_image_right | image_url: width: 1200 }}"
            srcset="
              {{ section.settings.panel_2_image_right | image_url: width: 600 }} 600w,
              {{ section.settings.panel_2_image_right | image_url: width: 900 }} 900w,
              {{ section.settings.panel_2_image_right | image_url: width: 1200 }} 1200w
            "
            sizes="(max-width: 768px) 80vw, 60vw"
            width="1200"
            height="800"
            alt="{{ section.settings.panel_2_image_right.alt | default: 'Right Image' | escape }}"
            loading="lazy"
            class="split-image">
        {%- else -%}
          <img
            src="{{ 'content3.jpg' | asset_url }}"
            width="1200"
            height="800"
            alt="Content 3"
            loading="lazy"
            class="split-image">
        {%- endif -%}
      </div>
    </div>

    {%- comment -%} Panel 3: Featured Image {%- endcomment -%}
    <div class="content">
      {%- if section.settings.panel_3_image != blank -%}
        <img
          src="{{ section.settings.panel_3_image | image_url: width: 1200 }}"
          srcset="
            {{ section.settings.panel_3_image | image_url: width: 600 }} 600w,
            {{ section.settings.panel_3_image | image_url: width: 900 }} 900w,
            {{ section.settings.panel_3_image | image_url: width: 1200 }} 1200w
          "
          sizes="50vw"
          width="1200"
          height="800"
          alt="{{ section.settings.panel_3_image.alt | default: 'Panel 3' | escape }}"
          loading="lazy"
          class="panel-image-full">
      {%- else -%}
        <img
          src="{{ 'content4.jpg' | asset_url }}"
          width="1200"
          height="800"
          alt="Content 4"
          loading="lazy"
          class="panel-image-full">
      {%- endif -%}
    </div>
  </div>
</section>

<script>
  (function() {
    'use strict';
  
    function initHorizontalScroller_{{ section.id | replace: '-', '_' }}() {
      // Kill existing ScrollTriggers to prevent duplicates/memory leaks on re-init
      ScrollTrigger.getAll().forEach(t => t.kill());
  
      if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') {
        setTimeout(initHorizontalScroller_{{ section.id | replace: '-', '_' }}, 100);
        return;
      }
  
      gsap.registerPlugin(ScrollTrigger);
  
      const sectionId = '#horizontal-{{ section.id }}';
      const wrapper = document.querySelector(sectionId + ' .scroller-wrapper');
  
      if (!wrapper) {
        console.warn('Horizontal scroller wrapper not found');
        return;
      }
  
      // Force a reflow and wait for CSS to be fully applied
      wrapper.offsetHeight; 
      
      setTimeout(() => {
        const scrollWidth = wrapper.scrollWidth;
        const viewportWidth = window.innerWidth;
  
        // 1. Horizontal Scroll Animation
        gsap.to(wrapper, {
          x: -(scrollWidth - viewportWidth),
          ease: 'none',
          force3D: true,
          scrollTrigger: {
            trigger: sectionId,
            pin: true,
            pinSpacing: true,
            scrub: 1.5,
            end: () => '+=' + (scrollWidth - viewportWidth),
            invalidateOnRefresh: true,
            anticipatePin: 1.5,
          },
        });
  
        // 2. Middle Section Stacking (Improved to prevent flicker)
        const middleSection = document.querySelector('.middle-image-section');
        if (middleSection) {
          gsap.timeline({
            scrollTrigger: {
              trigger: middleSection,
              pin: true,
              pinSpacing: true,
              scrub: 1.5,
              start: 'top top', 
              end: '+=100%',
              invalidateOnRefresh: true,
              anticipatePin: 1.5,
            },
          }).fromTo(middleSection, 
            { y: 150, force3D: true }, 
            { y: 0, ease: 'none', immediateRender: true }
          );
        }
  
        // 3. Large Section Stacking (Improved to prevent flicker)
        const largeSection = document.querySelector('.large-image-section');
        if (largeSection) {
          gsap.timeline({
            scrollTrigger: {
              trigger: largeSection,
              pin: true,
              pinSpacing: true,
              scrub: 1.5,
              start: 'top top',
              end: '+=100%',
              invalidateOnRefresh: true,
              anticipatePin: 1.5,
            },
          }).fromTo(largeSection, 
            { y: 150, force3D: true }, 
            { y: 0, ease: 'none', immediateRender: true }
          );
        }
        
        // Final refresh to lock in everything
        ScrollTrigger.refresh();
      }, 400);
  
  
      // Refresh on significant width changes only (prevents mobile URL bar flicker)
      let lastWidth = window.innerWidth;
      window.addEventListener('resize', function() {
        if (window.innerWidth !== lastWidth) {
          lastWidth = window.innerWidth;
          ScrollTrigger.refresh();
        }
      });
    }
  
    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHorizontalScroller_{{ section.id | replace: '-', '_' }});
    } else {
      initHorizontalScroller_{{ section.id | replace: '-', '_' }}();
    }
  
    // Handle Shopify Theme Editor events
    document.addEventListener('shopify:section:load', function(event) {
      // Re-init if this section or related sections are reloaded
      console.log('Shopify section loaded, refreshing ScrollTrigger', event.target);
      setTimeout(initHorizontalScroller_{{ section.id | replace: '-', '_' }}, 100);
    });
  })();
</script>

{% schema %}
  {
    "name": "Horizontal Scroller",
    "tag": "section",
    "class": "section-horizontal-scroller",
    "settings": [
      {
        "type": "header",
        "content": "General Settings"
      },
      {
        "type": "color",
        "id": "background_color",
        "label": "Background Color",
        "default": "#0f0f0f"
      },
      {
        "type": "range",
        "id": "scroll_smoothness",
        "min": 0,
        "max": 2,
        "step": 0.1,
        "unit": "s",
        "label": "Scroll Smoothness (0 = Instant)",
        "default": 1
      },
      {
        "type": "header",
        "content": "Panel 1 - Full Width Image"
      }, {
        "type": "image_picker",
        "id": "panel_1_image",
        "label": "Image",
        "info": "Leave empty to use default content1.jpg"
      }, {
        "type": "header",
        "content": "Panel 2 - Split Layout"
      }, {
        "type": "image_picker",
        "id": "panel_2_image_left",
        "label": "Left Image",
        "info": "Leave empty to use default content2.jpg"
      }, {
        "type": "image_picker",
        "id": "panel_2_image_right",
        "label": "Right Image",
        "info": "Leave empty to use default content3.jpg"
      }, {
        "type": "header",
        "content": "Panel 3 - Custom Width Image"
      }, {
        "type": "image_picker",
        "id": "panel_3_image",
        "label": "Image",
        "info": "Leave empty to use default content4.jpg"
      }, {
        "type": "range",
        "id": "panel_3_width",
        "min": 30,
        "max": 100,
        "step": 5,
        "unit": "vw",
        "label": "Panel Width",
        "default": 70
      }
    ],
    "presets": [
      {
        "name": "Horizontal Scroller"
      }
    ]
  }
{% endschema %}